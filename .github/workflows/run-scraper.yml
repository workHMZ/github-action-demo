# =============================================================================
# å®šæ—¶è¿è¡Œçˆ¬è™« + å‘é€é€šçŸ¥åˆ° Synology Chat
# =============================================================================
# è§¦å‘ï¼šæ¯å¤©æ—©ä¸Š 8:00 (JST) è‡ªåŠ¨è¿è¡Œ æˆ– æ‰‹åŠ¨è§¦å‘
# åŠŸèƒ½ï¼šè¿è¡Œäº¤é€šçˆ¬è™«ï¼Œå°†ç»“æœå‘é€åˆ° Synology Chat
# =============================================================================

name: ğŸ” Run Scraper (Daily 8AM)

on:
  # å®šæ—¶è§¦å‘ï¼šæ¯å¤©æ—©ä¸Š 8:00 JST (= å‰ä¸€å¤© 23:00 UTC)
  schedule:
    - cron: '0 23 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      pull_latest:
        description: 'æ˜¯å¦æ‹‰å–æœ€æ–°é•œåƒï¼Ÿ'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      send_notification:
        description: 'æ˜¯å¦å‘é€é€šçŸ¥åˆ° Synology Chatï¼Ÿ'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  AZURE_RESOURCE_GROUP: rg-stirling-project
  AZURE_VM_NAME: vm-runner-transit-scraper
  IMAGE_NAME: github-action-demo
  CONTAINER_NAME: demo-runner
  SSH_USER: azureuser

jobs:
  run-scraper:
    name: ğŸš€ Run Scraper & Notify
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: âš¡ Start VM
        uses: azure/CLI@v2
        with:
          inlineScript: |
            echo "ğŸ”„ æ­£åœ¨å”¤é†’ VM..."
            az vm start \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --name ${{ env.AZURE_VM_NAME }}
            echo "âœ… VM å·²å¯åŠ¨ï¼"

      - name: ğŸŒ Get VM Public IP
        id: get-ip
        uses: azure/CLI@v2
        with:
          inlineScript: |
            IP=$(az vm show -d \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --name ${{ env.AZURE_VM_NAME }} \
              --query publicIps -o tsv)
            echo "ğŸ“ VM IP: $IP"
            echo "VM_IP=$IP" >> $GITHUB_OUTPUT

      - name: â³ Wait for SSH to be ready
        run: |
          echo "â³ ç­‰å¾… VM SSH æœåŠ¡å°±ç»ª..."
          for i in {1..12}; do
            if nc -z -w5 ${{ steps.get-ip.outputs.VM_IP }} 22 2>/dev/null; then
              echo "âœ… SSH æœåŠ¡å·²å°±ç»ªï¼"
              exit 0
            fi
            echo "å°è¯• $i/12: SSH æœªå°±ç»ªï¼Œç­‰å¾… 10 ç§’..."
            sleep 10
          done
          echo "âŒ SSH æœåŠ¡å¯åŠ¨è¶…æ—¶"
          exit 1

      - name: ğŸ³ Run Scraper & Send Notification
        uses: appleboy/ssh-action@v1.0.3
        env:
          DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          PULL_LATEST: ${{ github.event.inputs.pull_latest || 'false' }}
          SEND_NOTIFICATION: ${{ github.event.inputs.send_notification || 'true' }}
          SYNOLOGY_WEBHOOK: ${{ secrets.SYNOLOGY_CHAT_WEBHOOK }}
        with:
          host: ${{ steps.get-ip.outputs.VM_IP }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: DOCKER_IMAGE,CONTAINER_NAME,PULL_LATEST,SEND_NOTIFICATION,SYNOLOGY_WEBHOOK
          command_timeout: 10m
          script: |
            set -e
            
            echo "=========================================="
            echo "ğŸ§¹ æ¸…ç†æ—§å®¹å™¨..."
            echo "=========================================="
            sudo docker rm -f $CONTAINER_NAME 2>/dev/null || true
            
            # æ ¹æ®è®¾ç½®å†³å®šæ˜¯å¦æ‹‰å–é•œåƒ
            if [ "$PULL_LATEST" = "true" ]; then
              echo ""
              echo "=========================================="
              echo "ğŸ“¦ æ‹‰å–æœ€æ–°é•œåƒ..."
              echo "=========================================="
              sudo docker pull $DOCKER_IMAGE
            fi
            
            echo ""
            echo "=========================================="
            echo "ğŸš€ è¿è¡Œçˆ¬è™«..."
            echo "=========================================="
            
            # è¿è¡Œçˆ¬è™«å¹¶ä¿å­˜å®Œæ•´è¾“å‡º
            sudo docker run --rm --name $CONTAINER_NAME \
              -e PYTHONUNBUFFERED=1 \
              $DOCKER_IMAGE 2>&1 | tee /tmp/scraper_output.txt
            
            echo ""
            echo "=========================================="
            echo "ğŸ“¤ å¤„ç†å¹¶å‘é€é€šçŸ¥..."
            echo "=========================================="
            
            # æå– JSON éƒ¨åˆ†ï¼ˆä» { å¼€å§‹åˆ° } ç»“æŸçš„å®Œæ•´ JSONï¼‰
            grep -Pzo '\{[\s\S]*\}' /tmp/scraper_output.txt | head -c 5000 > /tmp/json_output.txt
            
            # è°ƒè¯•ï¼šæ˜¾ç¤ºæå–çš„ JSON
            echo "æå–çš„ JSON å†…å®¹:"
            cat /tmp/json_output.txt
            echo ""
            
            # å¦‚æœä¸éœ€è¦å‘é€é€šçŸ¥ï¼Œè·³è¿‡
            if [ "$SEND_NOTIFICATION" = "false" ]; then
              echo "â© è·³è¿‡é€šçŸ¥å‘é€"
              exit 0
            fi
            
            # å®‰è£… jqï¼ˆå¦‚æœæ²¡æœ‰ï¼‰
            if ! command -v jq &> /dev/null; then
              sudo apt-get update && sudo apt-get install -y jq
            fi
            
            # ä½¿ç”¨ jq è§£æ JSON
            UPDATE_TIME=$(jq -r '.update_time' /tmp/json_output.txt 2>/dev/null || echo "Unknown")
            ISSUE_COUNT=$(jq -r '.issue_count' /tmp/json_output.txt 2>/dev/null || echo "0")
            STATUS=$(jq -r '.status' /tmp/json_output.txt 2>/dev/null || echo "unknown")
            
            echo "è§£æç»“æœ: æ›´æ–°æ—¶é—´=$UPDATE_TIME, é—®é¢˜æ•°=$ISSUE_COUNT, çŠ¶æ€=$STATUS"
            
            # æ ¹æ®çŠ¶æ€æ„å»ºæ¶ˆæ¯
            if [ "$STATUS" = "all_clear" ]; then
              MESSAGE="âœ… ã€é–¢æ±äº¤é€šæƒ…å ±ã€‘å…¨ç·šæ­£å¸¸é‹è»¢ä¸­ï¼\n\nğŸ• æ›´æ–°æ™‚é–“: $UPDATE_TIME (JST)"
            else
              # ä½¿ç”¨ jq æå–è·¯çº¿ä¿¡æ¯
              LINES_INFO=$(jq -r '.issues[] | "â€¢ \(.line) [\(.status)]: \(.detail[0:25])..."' /tmp/json_output.txt 2>/dev/null | head -5 | tr '\n' '\n')
              
              MESSAGE="âš ï¸ ã€é–¢æ±äº¤é€šæƒ…å ±ã€‘${ISSUE_COUNT}ä»¶ã®é‹è¡Œæƒ…å ±\n\nğŸ• æ›´æ–°: $UPDATE_TIME (JST)\n\n${LINES_INFO}"
            fi
            
            echo "å‘é€æ¶ˆæ¯å†…å®¹:"
            echo -e "$MESSAGE"
            
            # å‘é€åˆ° Synology Chat
            curl -k -X POST "$SYNOLOGY_WEBHOOK" \
              -H "Content-Type: application/x-www-form-urlencoded" \
              --data-urlencode "payload={\"text\": \"$MESSAGE\"}"
            
            echo ""
            echo "=========================================="
            echo "âœ… å®Œæˆï¼"
            echo "=========================================="

      - name: ğŸ’° Stop VM (Save Money)
        if: always()
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az vm deallocate \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --name ${{ env.AZURE_VM_NAME }}
            echo "âœ… VM å·²å…³æœº"
