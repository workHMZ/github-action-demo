# =============================================================================
# æ‰‹åŠ¨è¿è¡Œçˆ¬è™«ï¼ˆä¸é‡æ–°æ„å»º/æ‹‰å–é•œåƒï¼‰
# =============================================================================
# ç”¨é€”ï¼šåªæƒ³çœ‹çˆ¬è™«ç»“æœæ—¶ï¼Œæ‰‹åŠ¨è§¦å‘æ­¤ workflow
# ç‰¹ç‚¹ï¼šè·³è¿‡ CI æ„å»ºï¼Œå¯é€‰æ‹©æ˜¯å¦æ‹‰å–æœ€æ–°é•œåƒ
# =============================================================================

name: ğŸ” Run Scraper Only

on:
  workflow_dispatch:
    inputs:
      pull_latest:
        description: 'æ˜¯å¦æ‹‰å–æœ€æ–°é•œåƒï¼Ÿï¼ˆä»£ç æ²¡å˜å°±é€‰ falseï¼‰'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  AZURE_RESOURCE_GROUP: rg-stirling-project
  AZURE_VM_NAME: vm-runner-transit-scraper
  IMAGE_NAME: github-action-demo
  CONTAINER_NAME: demo-runner
  SSH_USER: azureuser

jobs:
  run-scraper:
    name: ğŸš€ Run Scraper
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: âš¡ Start VM
        uses: azure/CLI@v2
        with:
          inlineScript: |
            echo "ğŸ”„ æ­£åœ¨å”¤é†’ VM..."
            az vm start \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --name ${{ env.AZURE_VM_NAME }}
            echo "âœ… VM å·²å¯åŠ¨ï¼"

      - name: ğŸŒ Get VM Public IP
        id: get-ip
        uses: azure/CLI@v2
        with:
          inlineScript: |
            IP=$(az vm show -d \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --name ${{ env.AZURE_VM_NAME }} \
              --query publicIps -o tsv)
            echo "ğŸ“ VM IP: $IP"
            echo "VM_IP=$IP" >> $GITHUB_OUTPUT

      - name: ğŸ³ Run Scraper via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          PULL_LATEST: ${{ github.event.inputs.pull_latest }}
        with:
          host: ${{ steps.get-ip.outputs.VM_IP }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: DOCKER_IMAGE,CONTAINER_NAME,PULL_LATEST
          command_timeout: 10m
          script: |
            set -e
            
            echo "=========================================="
            echo "ğŸ§¹ æ¸…ç†æ—§å®¹å™¨..."
            echo "=========================================="
            sudo docker rm -f $CONTAINER_NAME 2>/dev/null || echo "æ²¡æœ‰æ—§å®¹å™¨"
            
            # æ ¹æ®ç”¨æˆ·é€‰æ‹©å†³å®šæ˜¯å¦æ‹‰å–æœ€æ–°é•œåƒ
            if [ "$PULL_LATEST" = "true" ]; then
              echo ""
              echo "=========================================="
              echo "ğŸ“¦ æ‹‰å–æœ€æ–°é•œåƒ..."
              echo "=========================================="
              sudo docker pull $DOCKER_IMAGE
            else
              echo ""
              echo "=========================================="
              echo "â© è·³è¿‡æ‹‰å–é•œåƒï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­˜"
              echo "=========================================="
            fi
            
            echo ""
            echo "=========================================="
            echo "ğŸš€ è¿è¡Œçˆ¬è™«..."
            echo "=========================================="
            sudo docker run --rm --name $CONTAINER_NAME \
              -e PYTHONUNBUFFERED=1 \
              $DOCKER_IMAGE
            
            echo ""
            echo "=========================================="
            echo "âœ… å®Œæˆï¼"
            echo "=========================================="

      - name: ğŸ’° Stop VM (Save Money)
        if: always()
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az vm deallocate \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --name ${{ env.AZURE_VM_NAME }}
            echo "âœ… VM å·²å…³æœº"
