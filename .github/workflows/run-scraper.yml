# =============================================================================
# å®šæ—¶è¿è¡Œçˆ¬è™« + å‘é€é€šçŸ¥åˆ° Synology Chat
# =============================================================================
# è§¦å‘ï¼šæ¯å¤©æ—©ä¸Š 8:00 (JST) è‡ªåŠ¨è¿è¡Œ æˆ– æ‰‹åŠ¨è§¦å‘
# åŠŸèƒ½ï¼šè¿è¡Œäº¤é€šçˆ¬è™«ï¼Œå°†ç»“æœå‘é€åˆ° Synology Chat
# =============================================================================

name: ğŸ” Run Scraper (Daily 8AM)

on:
  # å®šæ—¶è§¦å‘ï¼šæ¯å¤©æ—©ä¸Š 8:00 JST (= å‰ä¸€å¤© 23:00 UTC)
  schedule:
    - cron: '0 23 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      pull_latest:
        description: 'æ˜¯å¦æ‹‰å–æœ€æ–°é•œåƒï¼Ÿ'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      send_notification:
        description: 'æ˜¯å¦å‘é€é€šçŸ¥åˆ° Synology Chatï¼Ÿ'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  AZURE_RESOURCE_GROUP: rg-stirling-project
  AZURE_VM_NAME: vm-runner-transit-scraper
  IMAGE_NAME: github-action-demo
  CONTAINER_NAME: demo-runner
  SSH_USER: azureuser

jobs:
  run-scraper:
    name: ğŸš€ Run Scraper & Notify
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: âš¡ Start VM
        uses: azure/CLI@v2
        with:
          inlineScript: |
            echo "ğŸ”„ æ­£åœ¨å”¤é†’ VM..."
            az vm start \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --name ${{ env.AZURE_VM_NAME }}
            echo "âœ… VM å·²å¯åŠ¨ï¼"

      - name: ğŸŒ Get VM Public IP
        id: get-ip
        uses: azure/CLI@v2
        with:
          inlineScript: |
            IP=$(az vm show -d \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --name ${{ env.AZURE_VM_NAME }} \
              --query publicIps -o tsv)
            echo "ğŸ“ VM IP: $IP"
            echo "VM_IP=$IP" >> $GITHUB_OUTPUT

      - name: ğŸ³ Run Scraper via SSH
        id: scraper
        uses: appleboy/ssh-action@v1.0.3
        env:
          DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          # å®šæ—¶è§¦å‘æ—¶é»˜è®¤ä¸æ‹‰å–é•œåƒï¼Œæ‰‹åŠ¨å¯é€‰
          PULL_LATEST: ${{ github.event.inputs.pull_latest || 'false' }}
        with:
          host: ${{ steps.get-ip.outputs.VM_IP }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: DOCKER_IMAGE,CONTAINER_NAME,PULL_LATEST
          command_timeout: 10m
          script: |
            set -e
            
            # æ¸…ç†æ—§å®¹å™¨
            sudo docker rm -f $CONTAINER_NAME 2>/dev/null || true
            
            # æ ¹æ®è®¾ç½®å†³å®šæ˜¯å¦æ‹‰å–é•œåƒ
            if [ "$PULL_LATEST" = "true" ]; then
              sudo docker pull $DOCKER_IMAGE
            fi
            
            # è¿è¡Œçˆ¬è™«å¹¶æ•è· JSON è¾“å‡º
            sudo docker run --rm --name $CONTAINER_NAME \
              -e PYTHONUNBUFFERED=1 \
              $DOCKER_IMAGE 2>&1 | tee /tmp/scraper_output.txt
            
            # åªæå– JSON éƒ¨åˆ†ï¼ˆä» { å¼€å§‹åˆ° } ç»“æŸï¼‰
            cat /tmp/scraper_output.txt | sed -n '/^{/,/^}/p'

      - name: ğŸ“¤ Send to Synology Chat
        # å®šæ—¶è§¦å‘æ—¶é»˜è®¤å‘é€ï¼Œæ‰‹åŠ¨å¯é€‰
        if: ${{ github.event.inputs.send_notification != 'false' }}
        env:
          SYNOLOGY_WEBHOOK: ${{ secrets.SYNOLOGY_CHAT_WEBHOOK }}
        run: |
          # ä» SSH è¾“å‡ºä¸­æå–ç»“æœ
          OUTPUT='${{ steps.scraper.outputs.stdout }}'
          
          # è§£æå…³é”®ä¿¡æ¯
          UPDATE_TIME=$(echo "$OUTPUT" | grep -o '"update_time": "[^"]*"' | cut -d'"' -f4 || echo "Unknown")
          ISSUE_COUNT=$(echo "$OUTPUT" | grep -o '"issue_count": [0-9]*' | grep -o '[0-9]*' || echo "0")
          STATUS=$(echo "$OUTPUT" | grep -o '"status": "[^"]*"' | cut -d'"' -f4 || echo "unknown")
          
          # æ„å»ºé€šçŸ¥æ¶ˆæ¯
          if [ "$STATUS" = "all_clear" ]; then
            EMOJI="âœ…"
            MESSAGE="$EMOJI ã€é–¢æ±äº¤é€šæƒ…å ±ã€‘å…¨ç·šæ­£å¸¸é‹è»¢ä¸­ï¼\\n\\nï¿½ æ›´æ–°æ™‚é–“: $UPDATE_TIME"
          else
            EMOJI="âš ï¸"
            # æå–æœ‰é—®é¢˜çš„è·¯çº¿åç§°
            ISSUES=$(echo "$OUTPUT" | grep -o '"line": "[^"]*"' | cut -d'"' -f4 | head -5 | tr '\n' 'ã€' | sed 's/ã€$//')
            MESSAGE="$EMOJI ã€é–¢æ±äº¤é€šæƒ…å ±ã€‘${ISSUE_COUNT}ä»¶ã®é‹è¡Œæƒ…å ±ã‚ã‚Š\\n\\nğŸšƒ å½±éŸ¿è·¯ç·š: $ISSUES\\nğŸ• æ›´æ–°æ™‚é–“: $UPDATE_TIME\\n\\nè©³ç´°ã¯ GitHub Actions ãƒ­ã‚°ã‚’ã”ç¢ºèªãã ã•ã„ã€‚"
          fi
          
          echo "ğŸ“¨ å‘é€é€šçŸ¥åˆ° Synology Chat..."
          echo "æ¶ˆæ¯å†…å®¹: $MESSAGE"
          
          # å‘é€åˆ° Synology Chat
          curl -k -X POST "$SYNOLOGY_WEBHOOK" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "payload={\"text\": \"$MESSAGE\"}"
          
          echo ""
          echo "âœ… é€šçŸ¥å·²å‘é€ï¼"

      - name: ğŸ’° Stop VM (Save Money)
        if: always()
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az vm deallocate \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --name ${{ env.AZURE_VM_NAME }}
            echo "âœ… VM å·²å…³æœº"
