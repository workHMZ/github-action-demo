# =============================================================================
# å®šæ—¶è¿è¡Œçˆ¬è™« + å‘é€é€šçŸ¥åˆ° Synology Chat
# =============================================================================
# è§¦å‘ï¼šæ¯å¤©æ—©ä¸Š 8:00 (JST) è‡ªåŠ¨è¿è¡Œ æˆ– æ‰‹åŠ¨è§¦å‘
# åŠŸèƒ½ï¼šè¿è¡Œäº¤é€šçˆ¬è™«ï¼Œå°†ç»“æœå‘é€åˆ° Synology Chat
# =============================================================================

name: ğŸ” Run Scraper (Daily 8AM)

on:
  # å®šæ—¶è§¦å‘ï¼šæ¯å¤©æ—©ä¸Š 8:00 JST (= å‰ä¸€å¤© 23:00 UTC)
  schedule:
    - cron: '0 23 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      send_notification:
        description: 'æ˜¯å¦å‘é€é€šçŸ¥åˆ° Synology Chatï¼Ÿ'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  run-scraper:
    name: ğŸš€ Run Scraper & Notify
    runs-on: ubuntu-latest

    steps:
      - name: ï¿½ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ï¿½ Install dependencies
        run: |
          pip install selenium webdriver-manager

      - name: ğŸš€ Run Scraper
        id: scraper
        run: |
          echo "=========================================="
          echo " è¿è¡Œçˆ¬è™«..."
          echo "=========================================="
          
          python app.py 2>&1 | tee /tmp/scraper_output.txt
          
          echo ""
          echo "=========================================="
          echo "ğŸ“¤ å¤„ç†è¾“å‡º..."
          echo "=========================================="
          
          # æå– JSON éƒ¨åˆ†
          grep -Pzo '\{[\s\S]*\}' /tmp/scraper_output.txt | head -c 5000 > /tmp/json_output.txt || true
          
          echo "æå–çš„ JSON å†…å®¹:"
          cat /tmp/json_output.txt
          echo ""

      - name: ğŸ“¤ Send Notification to Synology Chat
        if: ${{ github.event.inputs.send_notification != 'false' }}
        env:
          SYNOLOGY_WEBHOOK: ${{ secrets.SYNOLOGY_CHAT_WEBHOOK }}
        run: |
          echo "=========================================="
          echo "ğŸ“¤ å‘é€é€šçŸ¥åˆ° Synology Chat..."
          echo "=========================================="
          
          # ä½¿ç”¨ jq è§£æ JSON
          UPDATE_TIME=$(jq -r '.update_time' /tmp/json_output.txt 2>/dev/null || echo "Unknown")
          ISSUE_COUNT=$(jq -r '.issue_count' /tmp/json_output.txt 2>/dev/null || echo "0")
          STATUS=$(jq -r '.status' /tmp/json_output.txt 2>/dev/null || echo "unknown")
          
          echo "è§£æç»“æœ: æ›´æ–°æ—¶é—´=$UPDATE_TIME, é—®é¢˜æ•°=$ISSUE_COUNT, çŠ¶æ€=$STATUS"
          
          # æ ¹æ®çŠ¶æ€æ„å»ºæ¶ˆæ¯
          if [ "$STATUS" = "all_clear" ]; then
            MESSAGE="âœ… ã€é–¢æ±äº¤é€šæƒ…å ±ã€‘å…¨ç·šæ­£å¸¸é‹è»¢ä¸­ï¼\n\nğŸ• æ›´æ–°æ™‚é–“: $UPDATE_TIME (JST)"
          else
            # ä½¿ç”¨ jq æå–è·¯çº¿ä¿¡æ¯
            LINES_INFO=$(jq -r '.issues[] | "â€¢ \(.line) [\(.status)]: \(.detail[0:25])..."' /tmp/json_output.txt 2>/dev/null | head -5 | tr '\n' '\n')
            
            MESSAGE="âš ï¸ ã€é–¢æ±äº¤é€šæƒ…å ±ã€‘${ISSUE_COUNT}ä»¶ã®é‹è¡Œæƒ…å ±\n\nğŸ• æ›´æ–°: $UPDATE_TIME (JST)\n\n${LINES_INFO}"
          fi
          
          echo "å‘é€æ¶ˆæ¯å†…å®¹:"
          echo -e "$MESSAGE"
          
          # å‘é€åˆ° Synology Chat
          curl -k -X POST "$SYNOLOGY_WEBHOOK" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "payload={\"text\": \"$MESSAGE\"}"
          
          echo ""
          echo "=========================================="
          echo "âœ… å®Œæˆï¼"
          echo "=========================================="
